# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë  REUSABLE: Deploy to Staging                                   ‚ïë
# ‚ïë  Supports web (Vercel), API (container), and mobile (APK)     ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
name: "Reusable: Deploy to Staging"

on:
  workflow_call:
    inputs:
      system-dir:
        required: false
        type: string
        default: "."
        description: "System directory name"
      system-name:
        required: true
        type: string
        description: "System name for artifacts/display"
      app-type:
        required: true
        type: string
        description: "Application type (web|api|mobile)"
      artifact-name:
        required: true
        type: string
        description: "Artifact name to download"
      staging-url:
        required: false
        type: string
        default: ""
        description: "Expected staging URL for health check"
      enable-health-check:
        required: false
        type: boolean
        default: true
        description: "Run post-deploy health check"
    outputs:
      deployment-url:
        description: "Staging deployment URL"
        value: ${{ jobs.deploy-staging.outputs.url }}
      deployment-status:
        description: "Deployment status"
        value: ${{ jobs.deploy-staging.outputs.status }}

jobs:
  deploy-staging:
    name: "Deploy to Staging"
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.url }}
    outputs:
      url: ${{ steps.deploy.outputs.url }}
      status: ${{ steps.deploy.outputs.status }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: ./build

      - name: Deploy to Staging
        id: deploy
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë   STAGING DEPLOYMENT                         ‚ïë"
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
          echo "‚ïë System:    ${{ inputs.system-name }}"
          echo "‚ïë Type:      ${{ inputs.app-type }}"
          echo "‚ïë Branch:    ${{ github.ref_name }}"
          echo "‚ïë Commit:    ${{ github.sha }}"
          echo "‚ïë Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"

          # Route deployment by app type
          case "${{ inputs.app-type }}" in
            web)
              echo "üåê Deploying web app to staging..."
              # Vercel / Firebase / S3 deployment commands here
              echo "url=https://${{ inputs.system-name }}-staging.vercel.app" >> $GITHUB_OUTPUT
              ;;
            api)
              echo "‚öôÔ∏è Deploying backend API to staging..."
              # Docker / cloud provider deployment commands here
              echo "url=https://${{ inputs.system-name }}-staging.api.example.com" >> $GITHUB_OUTPUT
              ;;
            mobile)
              echo "üì± Publishing mobile APK to staging..."
              # Upload APK to GitHub Releases / internal distribution
              echo "url=https://github.com/${{ github.repository }}/releases" >> $GITHUB_OUTPUT
              ;;
          esac

          echo "status=success" >> $GITHUB_OUTPUT
          echo "‚úÖ Staging deployment completed"

      - name: Post-Deploy Health Check
        if: ${{ inputs.enable-health-check && inputs.staging-url != '' }}
        run: |
          echo "üè• Running health check on ${{ inputs.staging-url }}..."
          for i in 1 2 3 4 5; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ inputs.staging-url }}/health" || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ Health check passed (attempt $i)"
              exit 0
            fi
            echo "‚è≥ Attempt $i: Status $STATUS ‚Äî retrying in 10s..."
            sleep 10
          done
          echo "‚ùå Health check failed after 5 attempts"
          exit 1

      - name: Create Deployment Log
        if: always()
        run: |
          cat << EOF > deployment-log.json
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "system": "${{ inputs.system-name }}",
            "app_type": "${{ inputs.app-type }}",
            "environment": "staging",
            "commit_sha": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "deployed_by": "${{ github.actor }}",
            "status": "${{ steps.deploy.outputs.status }}",
            "url": "${{ steps.deploy.outputs.url }}",
            "run_id": "${{ github.run_id }}"
          }
          EOF
          cat deployment-log.json

      - name: Upload Deployment Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.system-name }}-staging-deployment-log
          path: deployment-log.json
          retention-days: 90
