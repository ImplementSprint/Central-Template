# ╔══════════════════════════════════════════════════════════════════╗
# ║  REUSABLE: Pipeline Notifications                              ║
# ║  Sends failure/success alerts to configured channels          ║
# ╚══════════════════════════════════════════════════════════════════╝
name: "Reusable: Pipeline Notifications"

on:
  workflow_call:
    inputs:
      status:
        required: true
        type: string
        description: "Pipeline status (success|failure|cancelled)"
      system-dir:
        required: true
        type: string
        description: "System name or comma-separated system names"
      pipeline-type:
        required: false
        type: string
        default: "CI/CD"
        description: "Pipeline type (CI/CD, Staging, Production)"
      error-details:
        required: false
        type: string
        default: ""
        description: "Error details for failure notifications"
    secrets:
      SLACK_WEBHOOK_URL:
        required: false
      DISCORD_WEBHOOK_URL:
        required: false

jobs:
  notify:
    name: "Send Notification"
    runs-on: ubuntu-latest
    env:
      HAS_SLACK: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
      HAS_DISCORD: ${{ secrets.DISCORD_WEBHOOK_URL != '' }}
    steps:
      - name: Prepare Notification
        id: prepare
        env:
          STATUS: ${{ inputs.status }}
          SYSTEM_DIR: ${{ inputs.system-dir }}
          PIPELINE_TYPE: ${{ inputs.pipeline-type }}
          BRANCH_NAME: ${{ github.ref_name }}
          ACTOR_NAME: ${{ github.actor }}
          COMMIT_SHA: ${{ github.sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ "${STATUS}" = "success" ]; then
            EMOJI="✅"
            COLOR="good"
            DISCORD_COLOR="3066993"
            TITLE="Pipeline Succeeded"
          elif [ "${STATUS}" = "failure" ]; then
            EMOJI="❌"
            COLOR="danger"
            DISCORD_COLOR="15158332"
            TITLE="Pipeline Failed"
          else
            EMOJI="⚠️"
            COLOR="warning"
            DISCORD_COLOR="16776960"
            TITLE="Pipeline Cancelled"
          fi

          if [ "${STATUS}" = "failure" ] || [ "${STATUS}" = "cancelled" ]; then
            MENTION="<!here>"
          else
            MENTION=""
          fi

          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT
          echo "discord_color=$DISCORD_COLOR" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "mention=$MENTION" >> $GITHUB_OUTPUT

          echo "$EMOJI $TITLE"
          echo "  Systems:  ${SYSTEM_DIR}"
          echo "  Pipeline: ${PIPELINE_TYPE}"
          echo "  Branch:   ${BRANCH_NAME}"
          echo "  Commit:   ${COMMIT_SHA}"
          echo "  Actor:    ${ACTOR_NAME}"
          echo "  Run URL:  ${RUN_URL}"

      - name: Notify Slack
        if: env.HAS_SLACK == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          retry() {
            local attempts=$1
            local delay=$2
            shift 2
            local count=1
            until "$@"; do
              if [ "$count" -ge "$attempts" ]; then
                return 1
              fi
              sleep "$delay"
              count=$((count + 1))
            done
          }

          retry 3 3 curl -sS -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"${{ steps.prepare.outputs.mention }}\",
              \"attachments\": [{
                \"color\": \"${{ steps.prepare.outputs.color }}\",
                \"title\": \"${{ steps.prepare.outputs.emoji }} ${{ steps.prepare.outputs.title }}\",
                \"fields\": [
                  {\"title\": \"Systems\", \"value\": \"${{ inputs.system-dir }}\", \"short\": false},
                  {\"title\": \"Pipeline\", \"value\": \"${{ inputs.pipeline-type }}\", \"short\": true},
                  {\"title\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"short\": true},
                  {\"title\": \"Actor\", \"value\": \"${{ github.actor }}\", \"short\": true},
                  {\"title\": \"Run\", \"value\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\", \"short\": false}
                ],
                \"footer\": \"<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>\"
              }]
            }"

      - name: Notify Discord
        if: env.HAS_DISCORD == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          retry() {
            local attempts=$1
            local delay=$2
            shift 2
            local count=1
            until "$@"; do
              if [ "$count" -ge "$attempts" ]; then
                return 1
              fi
              sleep "$delay"
              count=$((count + 1))
            done
          }

          retry 3 3 curl -sS -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"content\": \"${{ steps.prepare.outputs.mention }}\",
              \"embeds\": [{
                \"title\": \"${{ steps.prepare.outputs.emoji }} ${{ steps.prepare.outputs.title }}\",
                \"color\": ${{ steps.prepare.outputs.discord_color }},
                \"description\": \"${{ inputs.error-details != '' && format('**Details:** {0}\\n', inputs.error-details) || '' }}\",
                \"fields\": [
                  {\"name\": \"Systems\", \"value\": \"${{ inputs.system-dir }}\", \"inline\": false},
                  {\"name\": \"Pipeline\", \"value\": \"${{ inputs.pipeline-type }}\", \"inline\": true},
                  {\"name\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"inline\": true},
                  {\"name\": \"Actor\", \"value\": \"${{ github.actor }}\", \"inline\": true}
                ],
                \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
              }]
            }"

